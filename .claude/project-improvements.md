# 過去の試行錯誤・改善プロセス

## Git コミット単位の改善

### 現在の問題点
#### 大きすぎるコミット単位
- `204a67b`: 463行の変更（テトリミノ + ゲームロジック）
- `163f8de`: 377行の変更（テストフレームワーク + HTML + CSS + テスト）

#### 複数責務の混在
- 異なる機能を1つのコミットに含める
- テストと実装を同時にコミット
- ファイル作成とロジック実装の混在

### 失敗パターンの分析
#### なぜ大きなコミットになったか
1. **機能完成を急いだ**: TDD工程を理解していたが、コミットタイミングを見誤った
2. **変更範囲の見積もり不足**: 実装開始前に変更ファイル数を把握していなかった
3. **中間コミットの意識不足**: 機能途中でのコミットを躊躇した

### 改善プロセス
#### 推奨コミット単位（100-200行目安）
```
適切な分割例:
1. Add simple test framework for TDD approach (test-runner.js のみ)
2. Add basic HTML structure for Tetris game (index.html のみ)
3. Add CSS styling for game interface (style.css のみ)
4. Add comprehensive test cases for Tetris core logic (tetris.test.js のみ)
5. Implement Tetromino class with rotation logic (Tetrominoクラス部分)
6. Implement GameBoard class with collision detection (GameBoardクラス部分)
7. Implement line clearing and validation logic (ライン消去ロジック)
8. Implement main game loop and controls (TetrisGameクラス基本部分)
9. Add scoring and level progression system (スコア計算部分)
10. Add game over handling and UI (ゲームオーバー処理)
```

#### 今後のコミット戦略
- **1コミット = 1機能または1修正**
- **テストと実装の分離**: テスト追加 → コミット → 実装 → コミット
- **独立動作保証**: 各コミット時点でエラーのない状態を維持
- **中間コミットの積極活用**: 機能が部分的でも意味のある単位でコミット

### 教訓
#### 学んだこと
- TDDの理解とコミット戦略は別のスキル
- コミット分割の計画は実装開始前に行う
- 「動く最小単位」での頻繁なコミットが重要

#### 次回適用すること
- 実装前にコミット計画の作成
- 機能実装中の定期的な進捗確認
- 200行を超えそうな場合の早期分割判断

## ライン消去アニメーション中のゲーム停止バグ修正

### 発生した問題
#### 症状
- ライン消去アニメーション再生中に次のテトリミノが落下するとゲームが停止
- 消去中にさらにラインを揃える条件で発生頻度が高い

#### 根本原因分析
1. **`placePiece()`で`currentPiece = null`に設定** (src/game.js:348)
2. **アニメーション中でも`update()`が継続実行**
3. **`movePieceDown()`が`null`の`currentPiece`にアクセスしてエラー**

#### 具体的な処理フロー
```
1. ピース配置 → this.currentPiece = null
2. ライン消去アニメーション開始
3. update()でmovePieceDown()呼び出し
4. this.currentPiece.x, this.currentPiece.yが null.x, null.y でエラー
```

### 修正内容
#### 1. `update()`メソッドに早期リターン追加
```javascript
// currentPieceが存在しない場合は処理を停止
if (!this.currentPiece) {
    return;
}
```

#### 2. 全ての操作メソッドにnullチェック追加
- `movePieceLeft()`, `movePieceRight()`, `movePieceDown()`
- `rotatePiece()`, `hardDrop()`

### 修正後の効果
- アニメーション中のクラッシュを防止
- 操作の安全性向上
- ゲームフローの安定化

### 教訓
#### 学んだこト
- 状態変更時の副作用考慮の重要性
- nullチェックの防御的プログラミング
- アニメーション処理と通常処理の分離設計

#### 今後の改善点
- より明確な状態管理設計の検討
- アニメーション専用の状態フラグ活用
- エラーハンドリングの体系化

## AIバランス調整（生存性改善）

### 発生した問題
#### 症状
- AI戦略改善後に積み上がりやすくなり、ゲームオーバー頻発
- テトリス狙いを優先しすぎて生存性が悪化

#### 根本原因分析
1. **井戸形成の過度な優先**: `tetrisSetup: 0.6` + 平常時1.5倍で過度重視
2. **高さペナルティ不足**: `height: -0.5`では井戸ボーナスに負ける
3. **危険度判定の甘さ**: 60%以上の高さで初めて危険判定

### 修正内容
#### 1. 重み調整（生存性重視）
```javascript
// 修正前
height: -0.5, tetrisSetup: 0.6, holes: -0.35

// 修正後  
height: -0.8, tetrisSetup: 0.35, holes: -0.5
```

#### 2. 動的調整強化
- 高さ50%超過時: テトリス狙い大幅抑制
- 危険度閾値を60%に早期化
- 深すぎる井戸(8層超)にペナルティ

#### 3. 井戸形成の安全化
- 指数ボーナス → 線形ボーナスに変更
- 構造ボーナス減少(30→20)
- 危険井戸の検出機能追加

### 期待効果
- 生存時間の大幅向上
- テトリス狙いと安全性のバランス改善
- より実践的なAI戦略

## 歯抜け対策システム（理論シミュレーション検証済み）

### シミュレーション結果
#### 検証シナリオ
- **底歯抜け**: 18行目に9ブロック+1穴 → 優先度72点、修復ボーナス82点
- **修復判定**: 歯抜け修復(86点) > テトリス準備(60点) ✅
- **I字完全修復**: 1200点ライン消去ボーナス ✅

### 最終調整（シミュレーション結果反映）
#### 強化された項目
1. **基本重み**: `gapRepair: 0.7 → 1.0`（43%強化）
2. **優先度計算**: 深度重み50→80、ブロック重み30→40（60%強化）
3. **アクセス性**: 上限10→20点、端ボーナス5→8点
4. **動的調整**: 危険時2.0→2.5倍、平常時1.5→1.8倍

#### 新しい評価値
- **平常時歯抜け修復**: 82 × 1.0 × 1.8 = **147.6点**
- **危険時歯抜け修復**: 82 × 1.0 × 2.5 = **205点**
- vs テトリス準備: 約60点

### 結果予測
- 歯抜け修復が2-3倍重視される
- 底の歯抜けに即座に対応
- ゲームオーバー率の大幅削減

## AI根本的見直し（実用重視への転換）

### 発生した問題
#### 症状
- AIが危険な高さまで無効率に積み上がる
- ライン消去が全く行われない（スクリーンショットでライン: 0）
- Perfect Clear戦略に偏りすぎて実用性に欠ける
- ゲームオーバー寸前まで適切な戦略が発動しない

#### 根本原因分析
1. **戦略選択の問題**
   - 緊急回避戦略が高さ16以上でしか発動しない
   - Perfect Clear戦略の条件が実用的でない（totalBlocks <= 40）
   - 中間的な安全戦略が不足

2. **評価パラメータの問題**
   - height評価が-39と軽すぎる
   - top_half(-150), top_quarter(-511)の重みが不適切
   - ライン消去評価が相対的に低い

3. **緊急時対応の欠如**
   - 高さ制限の閾値が高すぎる（16以上）
   - 安全戦略の優先度が低い

### 修正内容
#### 1. 評価パラメータの大幅見直し
```javascript
// 修正前
height: -39, top_half: -150, top_quarter: -511
clear1: 100, clear2: 250, clear3: 400, clear4: 800

// 修正後（安全重視）
height: -120, top_half: -400, top_quarter: -800
clear1: 200, clear2: 400, clear3: 650, clear4: 1000
```

#### 2. 戦略選択の完全リビルド
```javascript
// 新しい戦略階層（安全重視）
1. SUPER_EMERGENCY: maxHeight >= 14 or avgHeight >= 10
2. EMERGENCY: maxHeight >= 11 or avgHeight >= 8  
3. SAFETY_FIRST: maxHeight >= 8 or avgHeight >= 6
4. PERFECT_CLEAR: 序盤かつ安全時のみ（maxHeight <= 6）
5. T_SPIN_FOCUS: 中盤かつ安全時のみ（maxHeight <= 7）
6. BALANCED: ライン消去重視のデフォルト
```

#### 3. 先読み評価の改善
- 危険時の手数制限（14以上→3手、11以上→5手）
- 即座のライン消去ボーナス強化
- 安全性重視の評価重み調整

#### 4. ホールド戦略の実用化
- 危険時（高さ14以上）はホールド禁止
- Iピース（テトリス用）の戦略的保持
- T-spinセットアップ時のTピース保持

### 期待効果
- **生存性の大幅向上**: 早期の高さ制御
- **ライン消去の積極化**: 基本評価を200点に強化
- **戦略バランスの改善**: 実用性重視の戦略選択
- **緊急時応答の向上**: 3段階の安全戦略