<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå•é¡Œä¿®æ­£ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
        }
        .game-area {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-panel {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 500px;
            overflow-y: auto;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #005a8b;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #218838;
        }
        #gameCanvas {
            border: 2px solid #333;
            display: block;
            margin: 0 auto;
        }
        .stats {
            text-align: center;
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
        }
        .log-line {
            margin: 2px 0;
            word-wrap: break-word;
        }
        .log-ai { color: #00ffff; }
        .log-game { color: #ffff00; }
        .log-error { color: #ff0000; }
        .log-success { color: #00ff00; }
    </style>
</head>
<body>
    <h1 style="text-align: center;">ğŸ¤– AIå•é¡Œä¿®æ­£ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="container">
        <div class="controls">
            <h3>ãƒ†ã‚¹ãƒˆåˆ¶å¾¡</h3>
            <button onclick="startAutoplay()" class="success">ã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤é–‹å§‹</button>
            <button onclick="stopGame()" class="danger">ã‚²ãƒ¼ãƒ åœæ­¢</button>
            <button onclick="restartGame()">ã‚²ãƒ¼ãƒ å†èµ·å‹•</button>
            <button onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            
            <h3>AIè¨­å®š</h3>
            <label>ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«:</label>
            <select id="debugLevel" onchange="updateDebugLevel()">
                <option value="1">åŸºæœ¬</option>
                <option value="2" selected>è©³ç´°</option>
                <option value="3">å…¨ã¦</option>
            </select>
            
            <label>AIé›£æ˜“åº¦:</label>
            <select id="aiDifficulty">
                <option value="easy">ç°¡å˜</option>
                <option value="normal" selected>æ™®é€š</option>
                <option value="hard">é›£ã—ã„</option>
            </select>
            
            <h3>çµ±è¨ˆ</h3>
            <div id="stats">
                <div>ã‚¹ã‚³ã‚¢: <span id="score">0</span></div>
                <div>ãƒ©ã‚¤ãƒ³: <span id="lines">0</span></div>
                <div>ãƒ¬ãƒ™ãƒ«: <span id="level">1</span></div>
                <div>å®Ÿè¡Œå›æ•°: <span id="aiMoves">0</span></div>
                <div>æ¶ˆå»æˆåŠŸ: <span id="linesCleared">0</span></div>
            </div>
        </div>
        
        <div class="game-area">
            <canvas id="gameCanvas" width="300" height="600"></canvas>
            <div class="stats">
                <div>ç¾åœ¨ãƒ”ãƒ¼ã‚¹: <span id="currentPiece">-</span></div>
                <div>AIçŠ¶æ…‹: <span id="aiStatus">åœæ­¢ä¸­</span></div>
            </div>
        </div>
        
        <div class="debug-panel" id="debugLog">
            <div class="log-success">AIä¿®æ­£ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° - æº–å‚™å®Œäº†</div>
            <div class="log-ai">ã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤é–‹å§‹ã§ãƒ†ã‚¹ãƒˆé–‹å§‹</div>
        </div>
    </div>
    
    <!-- ã‚²ãƒ¼ãƒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ -->
    <script src="src/tetris.js"></script>
    <script src="src/game-state.js"></script>
    <script src="src/hold-next.js"></script>
    <script src="src/autoplay.js"></script>
    <script src="src/game.js"></script>
    
    <script>
        let game = null;
        let aiMoveCount = 0;
        let linesClearedCount = 0;
        let isRunning = false;
        
        const debugLog = document.getElementById('debugLog');
        const statsElements = {
            score: document.getElementById('score'),
            lines: document.getElementById('lines'),
            level: document.getElementById('level'),
            aiMoves: document.getElementById('aiMoves'),
            linesCleared: document.getElementById('linesCleared'),
            currentPiece: document.getElementById('currentPiece'),
            aiStatus: document.getElementById('aiStatus')
        };
        
        // ãƒ­ã‚°å‡ºåŠ›
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'ai' ? 'log-ai' : 
                            type === 'game' ? 'log-game' :
                            type === 'error' ? 'log-error' :
                            type === 'success' ? 'log-success' : '';
            
            const logLine = document.createElement('div');
            logLine.className = `log-line ${className}`;
            logLine.textContent = `[${timestamp}] ${message}`;
            
            debugLog.appendChild(logLine);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            // 1000è¡Œã‚’è¶…ãˆãŸã‚‰å¤ã„ãƒ­ã‚°ã‚’å‰Šé™¤
            if (debugLog.children.length > 1000) {
                debugLog.removeChild(debugLog.firstChild);
            }
        }
        
        // å…ƒã®console.logã‚’æ‹¡å¼µ
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            const message = args.join(' ');
            
            if (message.includes('[AI')) {
                addLog(message, 'ai');
            } else if (message.includes('[ç§»å‹•å®Ÿè¡Œ]') || message.includes('[placePiece]') || message.includes('[ãƒ©ã‚¤ãƒ³æ¶ˆå»]')) {
                addLog(message, 'game');
            } else if (message.includes('Cold Clear') || message.includes('æ€è€ƒ') || message.includes('æˆ¦ç•¥')) {
                addLog(message, 'ai');
            } else {
                addLog(message);
            }
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addLog(args.join(' '), 'error');
        };
        
        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            if (!game) return;
            
            statsElements.score.textContent = game.score;
            statsElements.lines.textContent = game.lines;
            statsElements.level.textContent = game.level;
            statsElements.aiMoves.textContent = aiMoveCount;
            statsElements.linesCleared.textContent = linesClearedCount;
            statsElements.currentPiece.textContent = game.currentPiece ? game.currentPiece.type : '-';
            statsElements.aiStatus.textContent = isRunning ? 'å®Ÿè¡Œä¸­' : 'åœæ­¢ä¸­';
        }
        
        // ãƒ©ã‚¤ãƒ³æ¶ˆå»ç›£è¦–
        function monitorLineClearing() {
            if (!game) return;
            
            const currentLines = game.lines;
            if (currentLines > linesClearedCount) {
                const newLines = currentLines - linesClearedCount;
                linesClearedCount = currentLines;
                addLog(`âœ… ãƒ©ã‚¤ãƒ³æ¶ˆå»æˆåŠŸ: ${newLines}ãƒ©ã‚¤ãƒ³ (ç´¯è¨ˆ: ${linesClearedCount})`, 'success');
            }
        }
        
        // ã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤é–‹å§‹
        function startAutoplay() {
            try {
                addLog('=== ã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤é–‹å§‹ ===', 'success');
                
                if (game) {
                    game = null;
                }
                
                // ã‚²ãƒ¼ãƒ ä½œæˆ
                game = new TetrisGame();
                
                // ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«è¨­å®š
                const debugLevel = parseInt(document.getElementById('debugLevel').value);
                const difficulty = document.getElementById('aiDifficulty').value;
                
                addLog(`è¨­å®š: ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«=${debugLevel}, é›£æ˜“åº¦=${difficulty}`);
                
                // ã‚²ãƒ¼ãƒ é–‹å§‹
                game.startGame('autoplay', {
                    difficulty: difficulty,
                    speed: 1.0
                });
                
                // ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«è¨­å®š
                if (game.aiEngine) {
                    game.aiEngine.debugLevel = debugLevel;
                    addLog(`AI ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«è¨­å®š: ${debugLevel}`, 'ai');
                }
                
                isRunning = true;
                aiMoveCount = 0;
                linesClearedCount = 0;
                
                // å®šæœŸæ›´æ–°é–‹å§‹
                const updateInterval = setInterval(() => {
                    if (!isRunning || !game || game.gameOver) {
                        clearInterval(updateInterval);
                        isRunning = false;
                        if (game && game.gameOver) {
                            addLog('=== ã‚²ãƒ¼ãƒ çµ‚äº† ===', 'error');
                            addLog(`æœ€çµ‚çµæœ: ã‚¹ã‚³ã‚¢=${game.score}, ãƒ©ã‚¤ãƒ³=${game.lines}`, 'success');
                        }
                        return;
                    }
                    
                    updateStats();
                    monitorLineClearing();
                    
                    // AIå®Ÿè¡Œå›æ•°ã‚«ã‚¦ãƒ³ãƒˆ
                    if (game.aiEngine && game.currentPiece) {
                        // å®Ÿéš›ã®AIå®Ÿè¡Œã‚’ãƒˆãƒªã‚¬ãƒ¼
                        if (Date.now() - game.lastAIAction > game.aiThinkInterval) {
                            aiMoveCount++;
                        }
                    }
                }, 100);
                
                addLog('ã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤é–‹å§‹å®Œäº†', 'success');
                
            } catch (error) {
                addLog(`ã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('ã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚²ãƒ¼ãƒ åœæ­¢
        function stopGame() {
            isRunning = false;
            if (game) {
                game.gameOver = true;
            }
            addLog('ã‚²ãƒ¼ãƒ åœæ­¢', 'game');
        }
        
        // ã‚²ãƒ¼ãƒ å†èµ·å‹•
        function restartGame() {
            stopGame();
            setTimeout(() => {
                startAutoplay();
            }, 500);
        }
        
        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        function clearLogs() {
            debugLog.innerHTML = '<div class="log-success">ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†</div>';
        }
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«æ›´æ–°
        function updateDebugLevel() {
            if (game && game.aiEngine) {
                const newLevel = parseInt(document.getElementById('debugLevel').value);
                game.aiEngine.debugLevel = newLevel;
                addLog(`ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«å¤‰æ›´: ${newLevel}`, 'ai');
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼ã‚­ãƒ£ãƒƒãƒ
        window.addEventListener('error', (event) => {
            addLog(`ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼: ${event.error.message}`, 'error');
        });
        
        // åˆæœŸåŒ–å®Œäº†
        addLog('AIä¿®æ­£ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†', 'success');
        addLog('ã€Œã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤é–‹å§‹ã€ãƒœã‚¿ãƒ³ã§ãƒ†ã‚¹ãƒˆé–‹å§‹', 'ai');
    </script>
</body>
</html>